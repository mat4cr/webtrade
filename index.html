<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Trade Goal Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease;
            overflow-x: hidden; /* Prevent horizontal scroll when sidebar is out */
        }
        .dark {
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .light {
            background-color: #f7fafc; /* Light background */
            color: #2d3748; /* Dark text */
        }
        .card {
            background-color: #2d3748; /* Dark card background */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.3s ease;
        }
        .light .card {
            background-color: #ffffff; /* Light card background */
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #63b3ed; /* blue-400 */
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(99, 179, 237, 0.3);
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #63b3ed; /* blue-400 */
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 4px rgba(99, 179, 237, 0.3);
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        /* Spinner styles */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #63b3ed; /* blue-400 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Page styles - similar to modal overlay, but full screen content */
        .full-page-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Dimmed background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto; /* Allow content to scroll */
            padding: 1rem; /* Padding around content */
        }
        .full-page-content {
            background-color: #2d3748;
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%; /* Max width for larger screens */
            width: 100%; /* Full width on smaller screens */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        .light .full-page-content {
            background-color: #ffffff;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #cbd5e0;
            cursor: pointer;
            z-index: 1001; /* Ensures it's above other content */
        }
        .light .close-button {
            color: #4a5568;
        }
        /* FAB styles */
        .fab {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background-color: #63b3ed; /* blue-400 */
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            box-shadow: 0 8px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 999;
        }
        .fab:hover {
            background-color: #4299e1; /* darker blue */
            transform: scale(1.1);
        }
        .fab svg {
            width: 32px;
            height: 32px;
        }
        
        /* Custom styles for dashboard cards */
        .dashboard-card-metric {
            background-color: #2a2a2a; /* Darker card background from image */
            border-radius: 0.75rem;
            padding: 0.5rem; /* Further reduced padding */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            text-align: center; 
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Ensure content stays within */
        }
        .dashboard-card-title {
            font-size: 0.8rem; /* Slightly smaller title for more space */
            font-weight: 500; 
            color: #b0b0b0; 
            margin-bottom: 0.1rem; /* Very small margin */
        }
        .dashboard-card-value {
            font-size: 1.5rem; /* Set to 1.5rem as requested */
            font-weight: 900; /* Extra bold */
            color: #e2e8f0; 
            line-height: 1; /* Tighter line height */
            word-break: break-all; /* Allow breaking long numbers */
        }
        .dashboard-card-subtext {
            font-size: 0.65rem; /* Even smaller for subtext */
            color: #718096; 
            margin-top: 0.1rem; /* Very small margin */
        }
        /* Specific colors for Win Rate / Net Profit */
        .text-green-success {
            color: #34d399; /* green-500 */
        }
        .text-red-danger {
            color: #ef4444; /* red-500 */
        }
        .text-blue-main {
            color: #63b3ed; /* blue-400 */
        }
        .text-purple-accent {
            color: #a21cde; /* purple */
        }

        /* Sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: -250px; /* Hidden by default */
            width: 250px;
            height: 100%;
            background-color: #2d3748; /* Darker background for sidebar */
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
            transition: left 0.3s ease-in-out;
            z-index: 1000; /* Above main content */
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .light .sidebar {
            background-color: #ffffff; /* Light sidebar background */
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }
        .sidebar.open {
            left: 0; /* Show sidebar */
        }
        .sidebar .sidebar-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #4a5568; /* Light border in dark mode */
        }
        .light .sidebar .sidebar-header {
            border-bottom: 1px solid #e2e8f0; /* Darker border in light mode */
        }
        .sidebar .sidebar-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #63b3ed; /* Blue for title */
        }
        .sidebar .sidebar-close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: #cbd5e0;
            cursor: pointer;
        }
        .light .sidebar .sidebar-close-btn {
            color: #2d3748;
        }
        .sidebar-item {
            width: 100%;
            padding: 0.75rem 0.5rem;
            display: flex;
            align-items: center;
            font-size: 1.1rem;
            color: #e2e8f0;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
            margin-bottom: 0.5rem;
        }
        .light .sidebar-item {
            color: #2d3748;
        }
        .sidebar-item:hover {
            background-color: #4a5568; /* Darker hover */
        }
        .light .sidebar-item:hover {
            background-color: #edf2f7; /* Lighter hover */
        }
        .sidebar-item svg {
            margin-right: 0.75rem;
            width: 24px;
            height: 24px;
        }

        /* Overlay for sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black */
            z-index: 999; /* Below sidebar, above main content */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Menu Toggle Button */
        .menu-toggle-btn {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            background-color: #4a5568; /* gray-700 */
            color: #e2e8f0; /* light text */
            padding: 0.5rem;
            border-radius: 50%;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: background-color 0.3s ease;
            z-index: 20; /* Same as theme toggle before */
        }
        .light .menu-toggle-btn {
            background-color: #cbd5e0; /* gray-300 */
            color: #2d3748; /* dark text */
        }
        .menu-toggle-btn:hover {
            background-color: #636b77; /* darker gray */
        }
        .menu-toggle-btn svg {
            width: 24px;
            height: 24px;
        }

        /* Adjust main content when sidebar is open (optional, but good UX) */
        #mainContent.shifted {
            transform: translateX(250px); /* Shift content to the right */
        }
    </style>
</head>
<body>
    <!-- Message display for critical errors or loading states -->
    <div id="initialStatusMessage" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center text-xl font-bold text-gray-400 z-[1002] hidden">
        Načítání aplikace...
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vložte vaši Firebase konfiguraci ZDE
        // ZÍSKEJTE JI Z VAŠÍ FIREBASE CONSOLE (Project settings -> Your apps -> Web app)
        const firebaseConfig = {
  apiKey: "AIzaSyDBrU9o7Sm2_z1rE0E7wPqUf3C2JMFVxEM",
  authDomain: "mujobchodnidenik.firebaseapp.com",
  projectId: "mujobchodnidenik",
  storageBucket: "mujobchodnidenik.firebasestorage.app",
  messagingSenderId: "179489594925",
  appId: "1:179489594925:web:e17c9b0c8eba4890e922a4"
};
        // KONEC FIREBASE KONFIGURACE

        // Global Firebase variables (initialized in window.onload)
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; 
        // appId bude přímo z firebaseConfig.projectId, nebo pokud by byl potřeba jiný, tak z firebaseConfig.appId
        let projectAppId = firebaseConfig.projectId; 


        // Global application state variables
        const TRADING_DAYS_PER_YEAR = 250;
        let entries = []; // Stores all entries fetched from Firestore
        let globalSettings = { 
            initialOverallBalance: 40,
            targetPercentage: 3,
        };
        let equityChartInstance;
        let dailyPnLChartInstance;
        let currentSelectedPeriod = 'all'; 
        let editingEntryId = null;
        let confirmCallbackFn; // Callback for custom confirm dialog

        // Declare DOM elements (will be assigned in window.onload)
        let mainContent, dashboardPage, dailyEntryPage, settingsModal;
        let sidebar, sidebarOverlay, menuToggleBtn, sidebarCloseBtn, sidebarSettingsBtn, sidebarThemeToggle, sidebarSunIcon, sidebarMoonIcon;
        let dailyEntryPageTitle, dailyBalanceInput, profitLossInput, winningTradesInput, losingTradesInput, dateInput, notesInput, addOrUpdateEntryBtn, analyzeNotesBtn, aiAnalysisSection, aiAnalysisResult, aiLoadingSpinner;
        let historyTableBody, clearHistoryBtn;
        let dashboardInitialBalance, dashboardLastBalance, dashboardTarget, dashboardTargetPct, dashboardActual, progressBar, progressPercentage, statusMessage;
        let winRateDisplay, totalTradesDisplay, winsLossesSubtext, streaksDisplay, streaksSubtext, maxDailyProfitDisplay;
        let avgDailyProfitDisplay, latestProfitLossPctDisplay, maxDrawdownDisplay, profitLossDaysDisplay, weeklyProfitDisplay, avgRRDisplay;
        let monthlyTargetBalanceDisplay, monthlyProgressPercentage, monthlyProgressBar, monthlyRemainingAmount, monthlyTradingDaysCount;
        let yearlyTargetBalanceDisplay, yearlyProgressPercentage, yearlyProgressBar, yearlyRemainingAmount, yearlyTradingDaysCount;
        let periodSelect, currentPeriodLabel;
        let addEntryFab, closeDailyEntryPageBtn, closeSettingsModalBtn;
        let initialOverallBalanceInput, globalTargetPercentageInput, globalPercentageValueSpan, saveSettingsBtn, settingsStatusMessage, historyTargetPct;
        let customConfirmModal, confirmBtn, cancelBtn, confirmMessageElement;
        let initialStatusMessageElement; 


        // --- Helper Functions ---

        /**
         * Formats a number as a USD currency string.
         * @param {number} amount - The number to format.
         * @returns {string} The formatted currency string.
         */
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        };

        /**
         * Sets the default date input to today's date.
         */
        const setTodayDate = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); 
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
        };

        /**
         * Calculates the number of weekdays (Monday-Friday) in a given month.
         * Does not account for public holidays.
         * @param {number} year - The year (e.g., 2025).
         * @param {number} month - The month (0-indexed, e.g., 5 for June).
         * @returns {number} The count of weekdays in the month.
         */
        const getWeekdaysInMonth = (year, month) => {
            let count = 0;
            const date = new Date(year, month, 1);
            while (date.getMonth() === month) {
                const day = date.getDay();
                // Check if it's a weekday (Monday to Friday)
                if (day !== 0 && day !== 6) { // 0 = Sunday, 6 = Saturday
                    count++;
                }
                date.setDate(date.getDate() + 1);
            }
            return count;
        };

        /**
         * Toggles between dark and light themes.
         */
        const toggleTheme = () => {
            document.body.classList.toggle('dark');
            document.body.classList.toggle('light');

            // Update sidebar icons
            sidebarSunIcon.classList.toggle('hidden');
            sidebarMoonIcon.classList.toggle('hidden');

            if (document.body.classList.contains('dark')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
            // Re-render charts with new theme colors
            const { filteredEntries, initialBalanceForPeriod, periodName } = filterEntriesByPeriod(currentSelectedPeriod);
            renderCharts(filteredEntries, initialBalanceForPeriod);
        };

        /**
         * Applies the saved theme preference on page load.
         */
        const applySavedTheme = () => {
            const savedTheme = localStorage.getItem('theme') || 'dark'; 
            if (savedTheme === 'light') {
                document.body.classList.add('light');
                document.body.classList.remove('dark');
                sidebarMoonIcon.classList.add('hidden');
                sidebarSunIcon.classList.remove('hidden');
            } else {
                document.body.classList.add('dark');
                document.body.classList.remove('light');
                sidebarSunIcon.classList.add('hidden');
                sidebarMoonIcon.classList.remove('hidden');
            }
        };

        // --- Sidebar Functions ---
        const openSidebar = () => {
            sidebar.classList.add('open');
            sidebarOverlay.classList.add('active');
        };

        const closeSidebar = () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
        };


        // --- Firebase Data Handling ---

        /**
         * Sets up real-time listeners for entries and settings from Firestore.
         */
        const setupFirestoreListeners = () => {
            if (!db || !userId) {
                console.warn("Firestore or User ID not available yet for listeners. Skipping Firestore setup.");
                initialStatusMessageElement.textContent = "Chyba: Firestore nebo ID uživatele není připraveno. Zkuste znovu načíst stránku.";
                initialStatusMessageElement.classList.remove('hidden');
                return;
            }

            // Listener for entries collection
            const entriesColRef = collection(db, `artifacts/${projectAppId}/users/${userId}/entries`);
            onSnapshot(query(entriesColRef, orderBy('date', 'asc')), (snapshot) => {
                initialStatusMessageElement.classList.add('hidden'); // Hide loading message once data starts coming
                const fetchedEntries = [];
                snapshot.forEach(doc => {
                    fetchedEntries.push({ id: doc.id, ...doc.data() });
                });
                
                // Process fetched entries to include dateObject and cumulativeBalanceAfterEntry
                entries = fetchedEntries
                    .map(entry => ({ ...entry, dateObject: new Date(entry.date) }))
                    .map((entry, index, array) => {
                        const startBalanceForDay = (index === 0) ? globalSettings.initialOverallBalance : (parseFloat(array[index-1].balance) + parseFloat(array[index-1].actualProfitLoss));
                        const cumulativeBalanceAfterEntry = startBalanceForDay + parseFloat(entry.actualProfitLoss);
                        return { 
                            ...entry, 
                            balance: startBalanceForDay, // This is the opening balance for the day
                            cumulativeBalanceAfterEntry: cumulativeBalanceAfterEntry // This is the balance AFTER the day's PnL
                        };
                    });

                console.log("Entries fetched/updated from Firestore:", entries.length);
                populatePeriodFilter();
                applyPeriodFilter(currentSelectedPeriod); // Re-render UI based on current filter
            }, (error) => {
                console.error("Error fetching entries from Firestore:", error);
                statusMessage.textContent = 'Chyba při načítání záznamů z databáze.';
                statusMessage.style.color = '#ef4444';
                initialStatusMessageElement.textContent = `Chyba při načítání dat: ${error.message}. Zkontrolujte připojení nebo pravidla Firebase.`;
                initialStatusMessageElement.classList.remove('hidden');
            });

            // Listener for settings document
            const settingsDocRef = doc(db, `artifacts/${projectAppId}/users/${userId}/settings/app_settings`);
            onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const fetchedSettings = docSnap.data();
                    globalSettings.initialOverallBalance = fetchedSettings.initialOverallBalance;
                    globalSettings.targetPercentage = fetchedSettings.targetPercentage;
                    console.log("Settings fetched/updated from Firestore:", globalSettings);
                } else {
                    console.log("No settings found, using default and saving them.");
                    // Save default settings if none exist (this will trigger the onSnapshot again)
                    saveSettingsToFirestore({ ...globalSettings });
                }
            }, (error) => {
                console.error("Error fetching settings from Firestore:", error);
                // Can display a more subtle message for settings error if needed
            });
        };

        /**
         * Saves a new entry to Firestore.
         * @param {object} newEntry - The entry object to save.
         */
        const saveEntryToFirestore = async (newEntry) => {
            try {
                if (!db || !userId) throw new Error("Firestore or User ID not ready.");
                const entriesColRef = collection(db, `artifacts/${projectAppId}/users/${userId}/entries`);
                await addDoc(entriesColRef, newEntry);
                statusMessage.textContent = 'Záznam úspěšně přidán!';
                statusMessage.style.color = '#34d399';
                setTimeout(() => { statusMessage.textContent = 'Zadejte první záznam!'; statusMessage.style.color = ''; }, 3000);
            } catch (error) {
                console.error("Error saving entry to Firestore:", error);
                statusMessage.textContent = 'Chyba při ukládání záznamu.';
                statusMessage.style.color = '#ef4444';
            }
        };

        /**
         * Updates an existing entry in Firestore.
         * @param {string} entryId - The ID of the entry to update.
         * @param {object} updatedEntry - The updated entry object.
         */
        const updateEntryInFirestore = async (entryId, updatedEntry) => {
            try {
                if (!db || !userId) throw new Error("Firestore or User ID not ready.");
                const entryDocRef = doc(db, `artifacts/${projectAppId}/users/${userId}/entries`, entryId);
                await updateDoc(entryDocRef, updatedEntry);
                statusMessage.textContent = 'Záznam úspěšně aktualizován!';
                statusMessage.style.color = '#34d399';
                setTimeout(() => { statusMessage.textContent = 'Zadejte první záznam!'; statusMessage.style.color = ''; }, 3000);
            } catch (error) {
                console.error("Error updating entry in Firestore:", error);
                statusMessage.textContent = 'Chyba při aktualizaci záznamu.';
                statusMessage.style.color = '#ef4444';
            }
        };

        /**
         * Clears all entries from Firestore.
         */
        const clearAllEntriesFromFirestore = async () => {
            try {
                if (!db || !userId) throw new Error("Firestore or User ID not ready.");
                const entriesColRef = collection(db, `artifacts/${projectAppId}/users/${userId}/entries`);
                const q = query(entriesColRef);
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.log("No entries to delete.");
                    statusMessage.textContent = 'Historie je již prázdná.';
                    statusMessage.style.color = '#34d399';
                    setTimeout(() => { statusMessage.textContent = 'Zadejte první záznam!'; statusMessage.style.color = ''; }, 3000);
                    return;
                }

                // Batch delete for efficiency (max 500 operations per batch)
                const batch = writeBatch(db);
                querySnapshot.forEach((document) => {
                    batch.delete(document.ref);
                });
                await batch.commit();

                statusMessage.textContent = 'Historie byla vymazána.';
                statusMessage.style.color = '#ef4444';
                setTimeout(() => { statusMessage.textContent = 'Zadejte první záznam!'; statusMessage.style.color = ''; }, 3000);
            } catch (error) {
                console.error("Error clearing history from Firestore:", error);
                statusMessage.textContent = 'Chyba při mazání historie.';
                statusMessage.style.color = '#ef4444';
            }
        };

        /**
         * Saves settings to Firestore.
         * @param {object} newSettings - The settings object to save.
         */
        const saveSettingsToFirestore = async (newSettings) => {
            try {
                if (!db || !userId) throw new Error("Firestore or User ID not ready.");
                const settingsDocRef = doc(db, `artifacts/${projectAppId}/users/${userId}/settings/app_settings`);
                await setDoc(settingsDocRef, newSettings, { merge: true }); // Use merge to avoid overwriting other fields if they exist
                settingsStatusMessage.textContent = 'Nastavení uloženo!';
                settingsStatusMessage.style.color = '#34d399';
                settingsStatusMessage.classList.remove('hidden');
                setTimeout(() => {
                    settingsStatusMessage.classList.add('hidden');
                    closeSettingsModal();
                }, 1500);
            } catch (error) {
                console.error("Error saving settings to Firestore:", error);
                settingsStatusMessage.textContent = 'Chyba při ukládání nastavení.';
                settingsStatusMessage.style.color = '#ef4444';
                settingsStatusMessage.classList.remove('hidden');
            }
        };


        // --- Period Filter Logic ---

        /**
         * Populates the period selection dropdown based on available entries.
         */
        const populatePeriodFilter = () => {
            periodSelect.innerHTML = ''; // Clear existing options

            // Always add default options
            periodSelect.add(new Option('Celková historie', 'all'));
            
            const today = new Date();
            const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            const currentYearKey = `${today.getFullYear()}`;

            // Add Current Month/Year options only if data exists for them OR if no entries at all (to allow starting new data)
            const hasCurrentMonthData = entries.some(entry => {
                const entryMonthKey = `${entry.dateObject.getFullYear()}-${String(entry.dateObject.getMonth() + 1).padStart(2, '0')}`;
                return entryMonthKey === currentMonthKey;
            });
            const hasCurrentYearData = entries.some(entry => {
                const entryYearKey = `${entry.dateObject.getFullYear()}`;
                return entryYearKey === currentYearKey;
            });

            if (hasCurrentMonthData || entries.length === 0) {
                 periodSelect.add(new Option('Aktuální měsíc', 'current_month'));
            }

            if (hasCurrentYearData || entries.length === 0) {
                 periodSelect.add(new Option('Aktuální rok', 'current_year'));
            }
            
            const uniqueMonths = new Set(); 
            const uniqueYears = new Set();  

            entries.forEach(entry => {
                const date = entry.dateObject;
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const yearKey = `${date.getFullYear()}`;
                
                if (monthKey !== currentMonthKey) { // Avoid adding current month to historical list
                    uniqueMonths.add(monthKey);
                }
                if (yearKey !== currentYearKey) { // Avoid adding current year to historical list
                    uniqueYears.add(yearKey);
                }
            });

            // Add historical months
            if (uniqueMonths.size > 0) {
                periodSelect.add(new Option('--- Minulé měsíce ---', '', true)); // Separator
                // Sort in descending order to show most recent first in historical section
                Array.from(uniqueMonths).sort((a,b) => b.localeCompare(a)).forEach(monthKey => {
                    const [year, month] = monthKey.split('-');
                    const monthName = new Date(year, month - 1, 1).toLocaleString('cs-CZ', { month: 'long', year: 'numeric' });
                    periodSelect.add(new Option(monthName, `month_${monthKey}`));
                });
            }

            // Add historical years
            if (uniqueYears.size > 0) {
                periodSelect.add(new Option('--- Minulé roky ---', '', true)); // Separator
                // Sort in descending order
                Array.from(uniqueYears).sort((a,b) => b.localeCompare(a)).forEach(yearKey => {
                    periodSelect.add(new Option(`Rok ${yearKey}`, `year_${yearKey}`));
                });
            }

            // Set the previously selected value, or 'all' as default
            periodSelect.value = currentSelectedPeriod;
            // If the previously selected period is no longer in options (e.g., deleted all entries), default to 'all'
            if (!periodSelect.value && periodSelect.options.length > 0) { 
                periodSelect.value = 'all';
                currentSelectedPeriod = 'all';
            }
        };

        /**
         * Filters entries and calculates initial balance for the selected period.
         * @param {string} periodString - The selected period value (e.g., 'all', 'current_month', 'month_2025-06').
         * @returns {{filteredEntries: Array, initialBalanceForPeriod: number, periodName: string}}
         */
        const filterEntriesByPeriod = (periodString) => {
            let filtered = [...entries]; // Start with all entries
            let initialBalance = globalSettings.initialOverallBalance;
            let periodName = 'Celková historie';
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); // 0-indexed

            if (periodString === 'current_month') {
                periodName = `Aktuální měsíc (${today.toLocaleString('cs-CZ', { month: 'long', year: 'numeric' })})`;
                const startOfMonth = new Date(currentYear, currentMonth, 1);
                const endOfMonth = new Date(currentYear, currentMonth + 1, 0, 23, 59, 59, 999);
                
                filtered = entries.filter(entry => entry.dateObject >= startOfMonth && entry.dateObject <= endOfMonth);
                
                // Find initial balance for current month (last cumulative balance BEFORE this month)
                const lastEntryBeforeMonth = entries.findLast(entry => entry.dateObject < startOfMonth); // findLast for efficiency
                if (lastEntryBeforeMonth) {
                    initialBalance = lastEntryBeforeMonth.cumulativeBalanceAfterEntry;
                }

            } else if (periodString === 'current_year') {
                periodName = `Aktuální rok (${currentYear})`;
                const startOfYear = new Date(currentYear, 0, 1);
                const endOfYear = new Date(currentYear, 11, 31, 23, 59, 59, 999);

                filtered = entries.filter(entry => entry.dateObject >= startOfYear && entry.dateObject <= endOfYear);

                // Find initial balance for current year (last cumulative balance BEFORE this year)
                const lastEntryBeforeYear = entries.findLast(entry => entry.dateObject < startOfYear);
                if (lastEntryBeforeYear) {
                    initialBalance = lastEntryBeforeYear.cumulativeBalanceAfterEntry;
                }

            } else if (periodString.startsWith('month_')) {
                const [year, month] = periodString.substring(6).split('-');
                const selectedMonth = parseInt(month, 10) - 1; // 0-indexed month
                const selectedYear = parseInt(year, 10);

                periodName = new Date(selectedYear, selectedMonth, 1).toLocaleString('cs-CZ', { month: 'long', year: 'numeric' });
                const startOfMonth = new Date(selectedYear, selectedMonth, 1);
                const endOfMonth = new Date(selectedYear, selectedMonth + 1, 0, 23, 59, 59, 999);

                filtered = entries.filter(entry => entry.dateObject >= startOfMonth && entry.dateObject <= endOfMonth);

                // Find initial balance for selected historical month (last cumulative balance BEFORE this selected month)
                const lastEntryBeforeSelectedMonth = entries.findLast(entry => entry.dateObject < startOfMonth);
                if (lastEntryBeforeSelectedMonth) {
                    initialBalance = lastEntryBeforeSelectedMonth.cumulativeBalanceAfterEntry;
                }

            } else if (periodString.startsWith('year_')) {
                const selectedYear = parseInt(periodString.substring(5), 10);
                periodName = `Rok ${selectedYear}`;
                const startOfYear = new Date(selectedYear, 0, 1);
                const endOfYear = new Date(selectedYear, 11, 31, 23, 59, 59, 999);

                filtered = entries.filter(entry => entry.dateObject >= startOfYear && entry.dateObject <= endOfYear);

                // Find initial balance for selected historical year (last cumulative balance BEFORE this selected year)
                const lastEntryBeforeSelectedYear = entries.findLast(entry => entry.dateObject < startOfYear);
                if (lastEntryBeforeSelectedYear) {
                    initialBalance = lastEntryBeforeSelectedYear.cumulativeBalanceAfterEntry;
                }
            }
            // If periodString is 'all', filtered remains all entries and initialBalance is globalSettings.initialOverallBalance

            return { filteredEntries: filtered, initialBalanceForPeriod: initialBalance, periodName: periodName };
        };

        /**
         * Applies the selected period filter and re-renders the UI.
         * @param {string} periodString - The selected period value.
         */
        const applyPeriodFilter = (periodString) => {
            currentSelectedPeriod = periodString; // Save current selection
            const { filteredEntries, initialBalanceForPeriod, periodName } = filterEntriesByPeriod(periodString);
            
            currentPeriodLabel.textContent = periodName; // Update the label
            periodSelect.value = periodString; // Ensure the dropdown reflects the selection

            renderDashboard(filteredEntries, initialBalanceForPeriod);
            renderCharts(filteredEntries, initialBalanceForPeriod);
            renderHistory(filteredEntries); // Re-render history table with filtered data
        };

        // --- Rendering Functions ---

        /**
         * Renders the dashboard section based on filtered data.
         * @param {Array} filteredEntries - Entries filtered for the current period.
         * @param {number} initialBalanceForPeriod - The starting balance for the current period.
         */
        const renderDashboard = (filteredEntries, initialBalanceForPeriod) => {
            const currentTargetPercentage = globalSettings.targetPercentage;
            const dailyGrowthFactor = 1 + (currentTargetPercentage / 100);

            dashboardInitialBalance.textContent = formatCurrency(initialBalanceForPeriod);

            let totalWins = 0;
            let totalLosses = 0;
            let currentWinStreak = 0;
            let currentLossStreak = 0;
            let longestWinStreak = 0;
            let longestLossStreak = 0;
            let maxDailyProfit = 0; 

            let totalDailyProfitSum = 0;
            let profitDaysCount = 0;
            let lossDaysCount = 0;
            let totalProfitLossPctSum = 0;

            let totalPositiveProfit = 0; 
            let totalNegativeLoss = 0;   

            let cumulativeBalancesForDrawdown = [initialBalanceForPeriod]; 

            filteredEntries.forEach(entry => {
                totalWins += (entry.winningTrades || 0); 
                totalLosses += (entry.losingTrades || 0); 
                
                const actualProfitLoss = parseFloat(entry.actualProfitLoss);
                totalDailyProfitSum += actualProfitLoss;

                const dailyBalance = parseFloat(entry.balance);
                if (dailyBalance > 0) {
                    totalProfitLossPctSum += (actualProfitLoss / dailyBalance) * 100;
                }
                
                if (actualProfitLoss > 0) {
                    profitDaysCount++;
                    currentWinStreak++;
                    currentLossStreak = 0; 
                    if (actualProfitLoss > maxDailyProfit) {
                        maxDailyProfit = actualProfitLoss; 
                    }
                    totalPositiveProfit += actualProfitLoss;
                } else if (actualProfitLoss < 0) {
                    lossDaysCount++;
                    currentLossStreak++;
                    currentWinStreak = 0; 
                    totalNegativeLoss += Math.abs(actualProfitLoss); 
                } else {
                    currentWinStreak = 0;
                    currentLossStreak = 0;
                }
                longestWinStreak = Math.max(longestWinStreak, currentWinStreak);
                longestLossStreak = Math.max(longestLossStreak, currentLossStreak);

                const lastCumulativeBalance = cumulativeBalancesForDrawdown[cumulativeBalancesForDrawdown.length - 1];
                cumulativeBalancesForDrawdown.push(lastCumulativeBalance + actualProfitLoss);
            });
            
            const totalTrades = totalWins + totalLosses;
            const winRate = totalTrades > 0 ? (totalWins / totalTrades * 100).toFixed(0) : 0;

            winRateDisplay.textContent = `${winRate}%`;
            winsLossesSubtext.textContent = `${totalWins} Wins - ${totalLosses} Losses`;
            totalTradesDisplay.textContent = totalTrades;
            maxDailyProfitDisplay.textContent = formatCurrency(maxDailyProfit); 

            const avgDailyProfit = filteredEntries.length > 0 ? totalDailyProfitSum / filteredEntries.length : 0;
            const avgDailyProfitPct = filteredEntries.length > 0 ? totalProfitLossPctSum / filteredEntries.length : 0;
            avgDailyProfitDisplay.textContent = `${formatCurrency(avgDailyProfit)} / ${avgDailyProfitPct.toFixed(1)}%`;


            let latestProfitLossPct = 0;
            if (filteredEntries.length > 0) {
                const latestEntry = filteredEntries[filteredEntries.length - 1];
                const initialDayBalanceForLatest = parseFloat(latestEntry.balance);
                if (initialDayBalanceForLatest > 0) {
                    latestProfitLossPct = (parseFloat(latestEntry.actualProfitLoss) / initialDayBalanceForLatest) * 100;
                }
            }
            latestProfitLossPctDisplay.textContent = `${latestProfitLossPct.toFixed(1)}%`;
            latestProfitLossPctDisplay.classList.remove('text-green-success', 'text-red-danger', 'text-white', 'text-purple-accent');
            if (latestProfitLossPct > 0) latestProfitLossPctDisplay.classList.add('text-green-success');
            else if (latestProfitLossPct < 0) latestProfitLossPctDisplay.classList.add('text-red-danger');
            else latestProfitLossPctDisplay.classList.add('text-purple-accent'); 


            let peak = cumulativeBalancesForDrawdown[0];
            let maxDrawdown = 0;
            for (let i = 1; i < cumulativeBalancesForDrawdown.length; i++) {
                if (cumulativeBalancesForDrawdown[i] > peak) {
                    peak = cumulativeBalancesForDrawdown[i];
                } else {
                    if (peak > 0) { 
                        const currentDrawdown = (peak - cumulativeBalancesForDrawdown[i]) / peak * 100;
                        if (currentDrawdown > maxDrawdown) {
                            maxDrawdown = currentDrawdown;
                        }
                    }
                }
            }
            maxDrawdownDisplay.textContent = `${maxDrawdown.toFixed(1)}%`;
            maxDrawdownDisplay.classList.remove('text-green-success', 'text-red-danger');
            if (maxDrawdown > 0) maxDrawdownDisplay.classList.add('text-red-danger');
            else maxDrawdownDisplay.classList.add('text-green-success'); 


            profitLossDaysDisplay.innerHTML = `<span class="text-green-success">${profitDaysCount}</span> / <span class="text-red-danger">${lossDaysCount}</span>`;


            let weeklyProfit = 0;
            const recentEntries = filteredEntries.slice(Math.max(filteredEntries.length - 7, 0)); 
            recentEntries.forEach(entry => {
                weeklyProfit += parseFloat(entry.actualProfitLoss);
            });
            weeklyProfitDisplay.textContent = formatCurrency(weeklyProfit);
            weeklyProfitDisplay.classList.remove('text-green-success', 'text-red-danger', 'text-white', 'text-blue-main');
            if (weeklyProfit > 0) weeklyProfitDisplay.classList.add('text-green-success');
            else if (weeklyProfit < 0) weeklyProfitDisplay.classList.add('text-red-danger');
            else weeklyProfitDisplay.classList.add('text-blue-main');

            let averageRR = 'N/A';
            if (totalNegativeLoss > 0) { 
                averageRR = (totalPositiveProfit / totalNegativeLoss).toFixed(2);
            } else if (totalPositiveProfit > 0 && totalNegativeLoss === 0 && profitDaysCount > 0) {
                averageRR = 'Inf.'; 
            }
            avgRRDisplay.textContent = averageRR;
            avgRRDisplay.classList.remove('text-green-success', 'text-red-danger', 'text-purple-accent', 'text-white');
            if (averageRR === 'N/A') {
                avgRRDisplay.classList.add('text-white'); 
            } else if (averageRR === 'Inf.') {
                 avgRRDisplay.classList.add('text-green-success');
            }
            else if (parseFloat(averageRR) >= 1) {
                avgRRDisplay.classList.add('text-green-success');
            } else {
                avgRRDisplay.classList.add('text-red-danger');
            }


            let streaksText = '---';
            if (longestWinStreak > 0 && longestLossStreak > 0) {
                streaksText = `${longestWinStreak}W - ${longestLossStreak}L`;
            } else if (longestWinStreak > 0) {
                streaksText = `${longestWinStreak}W`;
            } else if (longestLossStreak > 0) {
                streaksText = `${longestLossStreak}L`;
            }
            streaksDisplay.textContent = streaksText;

            // Current cumulative balance for monthly/yearly goals based on filtered entries
            let currentCumulativeBalance = initialBalanceForPeriod;
            if (filteredEntries.length > 0) {
                currentCumulativeBalance = filteredEntries[filteredEntries.length - 1].cumulativeBalanceAfterEntry;
            }


            if (filteredEntries.length > 0) {
                const latestEntry = filteredEntries[filteredEntries.length - 1];
                const initialDayBalance = parseFloat(latestEntry.balance);
                const actualProfitLoss = parseFloat(latestEntry.actualProfitLoss);
                const latestClosingBalance = initialDayBalance + actualProfitLoss;

                const calculatedTarget = initialDayBalance * (currentTargetPercentage / 100);

                dashboardLastBalance.textContent = formatCurrency(latestClosingBalance); 
                dashboardTarget.textContent = formatCurrency(calculatedTarget);

                dashboardActual.textContent = formatCurrency(actualProfitLoss);
                dashboardActual.classList.remove('text-red-danger', 'text-green-success', 'text-white'); 
                if (actualProfitLoss > 0) {
                    dashboardActual.classList.add('text-green-success'); 
                } else if (actualProfitLoss < 0) {
                    dashboardActual.classList.add('text-red-danger'); 
                } else {
                    dashboardActual.classList.add('text-white'); 
                }

                let progress = 0;
                if (calculatedTarget > 0) {
                    progress = (actualProfitLoss / calculatedTarget) * 100;
                } else if (actualProfitLoss > 0) { 
                    progress = 100; 
                }
                progress = Math.min(progress, 100); 

                progressBar.style.width = `${progress}%`;
                progressPercentage.textContent = `${progress.toFixed(0)}%`;

                statusMessage.style.color = ''; 
                progressBar.classList.remove('bg-yellow-500', 'bg-red-500', 'bg-green-500', 'bg-blue-500'); 
                
                if (actualProfitLoss >= calculatedTarget) {
                    statusMessage.textContent = 'Cíl splněn! Gratulujeme!';
                    statusMessage.style.color = '#34d399'; 
                    progressBar.classList.add('bg-green-500');
                } else if (actualProfitLoss > 0) {
                    statusMessage.textContent = 'V zisku, ale pod cílem.';
                    statusMessage.style.color = '#FCD34D'; 
                    progressBar.classList.add('bg-blue-500'); 
                } else {
                    statusMessage.textContent = 'Ztráta/Pod cílem.';
                    statusMessage.style.color = '#ef4444'; 
                    progressBar.classList.add('bg-red-500');
                }
            } else {
                dashboardLastBalance.textContent = formatCurrency(initialBalanceForPeriod); 
                dashboardTarget.textContent = formatCurrency(initialBalanceForPeriod * (currentTargetPercentage / 100));
                dashboardActual.textContent = formatCurrency(0);
                progressBar.style.width = '0%';
                progressPercentage.textContent = '0%';
                statusMessage.textContent = 'Zadejte první záznam!';
                statusMessage.style.color = '';
                progressBar.classList.remove('bg-yellow-500', 'bg-red-500', 'bg-green-500');
                progressBar.classList.add('bg-blue-500'); 
                dashboardActual.classList.remove('text-red-danger', 'text-green-success'); 
                dashboardActual.classList.add('text-white'); 
            }

            // --- Dynamic Monthly Goal Calculation & Display for the SELECTED PERIOD ---
            let monthlyTargetDate = new Date(); // Default to today
            if (filteredEntries.length > 0) {
                monthlyTargetDate = filteredEntries[0].dateObject; 
            }
            const monthForTarget = monthlyTargetDate.getMonth();
            const yearForTarget = monthlyTargetDate.getFullYear();
            const monthlyTradingDays = getWeekdaysInMonth(yearForTarget, monthForTarget);

            monthlyTradingDaysCount.textContent = monthlyTradingDays; 

            const projectedMonthlyTarget = initialBalanceForPeriod * Math.pow(dailyGrowthFactor, monthlyTradingDays);
            monthlyTargetBalanceDisplay.textContent = formatCurrency(projectedMonthlyTarget);

            let monthlyProgressValue = 0;
            const monthlyTargetGrowthAmount = projectedMonthlyTarget - initialBalanceForPeriod; 
            const currentGrowthAmount = currentCumulativeBalance - initialBalanceForPeriod; 

            if (monthlyTargetGrowthAmount > 0) {
                monthlyProgressValue = (currentGrowthAmount / monthlyTargetGrowthAmount) * 100;
            } else if (currentGrowthAmount > 0) { 
                monthlyProgressValue = 100; 
            }
            monthlyProgressValue = Math.min(Math.max(monthlyProgressValue, 0), 100).toFixed(0); 
            
            monthlyProgressPercentage.textContent = `${monthlyProgressValue}%`;
            monthlyProgressBar.style.width = `${monthlyProgressValue}%`;
            monthlyProgressBar.classList.remove('bg-yellow-500', 'bg-red-500', 'bg-green-500', 'bg-blue-500'); 

            let monthlyRemainingAmountValue = projectedMonthlyTarget - currentCumulativeBalance;
            if (monthlyRemainingAmountValue <= 0) {
                monthlyRemainingAmount.textContent = "Cíl splněn!";
                monthlyRemainingAmount.classList.remove('text-red-danger', 'text-white', 'text-blue-main');
                monthlyRemainingAmount.classList.add('text-green-success');
                monthlyProgressBar.classList.add('bg-green-500');
            } else {
                monthlyRemainingAmount.textContent = `Zbývá: ${formatCurrency(monthlyRemainingAmountValue)}`;
                monthlyRemainingAmount.classList.remove('text-green-success', 'text-white');
                if (currentGrowthAmount > 0) { 
                    monthlyRemainingAmount.classList.add('text-blue-main');
                    monthlyProgressBar.classList.add('bg-blue-500');
                } else { 
                    monthlyRemainingAmount.classList.add('text-red-danger');
                    monthlyProgressBar.classList.add('bg-red-500');
                }
            }


            // --- Yearly Goal Calculation & Display for the SELECTED PERIOD ---
            let yearlyTargetDate = new Date(); 
            if (filteredEntries.length > 0) {
                yearlyTargetDate = filteredEntries[0].dateObject; 
            }
            const yearlyTradingDays = TRADING_DAYS_PER_YEAR; 
            yearlyTradingDaysCount.textContent = yearlyTradingDays; 

            const projectedYearlyTarget = initialBalanceForPeriod * Math.pow(dailyGrowthFactor, yearlyTradingDays);
            yearlyTargetBalanceDisplay.textContent = formatCurrency(projectedYearlyTarget);

            let yearlyProgressValue = 0;
            const yearlyTargetGrowthAmount = projectedYearlyTarget - initialBalanceForPeriod; 
            
            if (yearlyTargetGrowthAmount > 0) {
                yearlyProgressValue = (currentGrowthAmount / yearlyTargetGrowthAmount) * 100;
            } else if (currentGrowthAmount > 0) { 
                yearlyProgressValue = 100; 
            }
            yearlyProgressValue = Math.min(Math.max(yearlyProgressValue, 0), 100).toFixed(0); 
            yearlyProgressPercentage.textContent = `${yearlyProgressValue}%`;
            yearlyProgressBar.style.width = `${yearlyProgressValue}%`;
            yearlyProgressBar.classList.remove('bg-yellow-500', 'bg-red-500', 'bg-green-500', 'bg-blue-500'); 

            let yearlyRemainingAmountValue = projectedYearlyTarget - currentCumulativeBalance;
            if (yearlyRemainingAmountValue <= 0) {
                yearlyRemainingAmount.textContent = "Cíl splněn!";
                yearlyRemainingAmount.classList.remove('text-red-danger', 'text-white', 'text-blue-main');
                yearlyRemainingAmount.classList.add('text-green-success');
                yearlyProgressBar.classList.add('bg-green-500');
            } else {
                yearlyRemainingAmount.textContent = `Zbývá: ${formatCurrency(yearlyRemainingAmountValue)}`;
                yearlyRemainingAmount.classList.remove('text-green-success', 'text-white');
                if (currentGrowthAmount > 0) { 
                    yearlyRemainingAmount.classList.add('text-blue-main');
                    yearlyProgressBar.classList.add('bg-blue-500');
                } else { 
                    yearlyRemainingAmount.classList.add('text-red-danger');
                    yearlyProgressBar.classList.add('bg-red-500');
                }
            }
        };

        /**
         * Renders the history table with filtered data.
         * @param {Array} entriesToRender - Entries to display in the table.
         */
        const renderHistory = (entriesToRender) => {
            historyTableBody.innerHTML = ''; 
            if (entriesToRender.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-gray-400 light:text-gray-600">Žádné záznamy pro toto období.</td></tr>`;
                return;
            }

            entriesToRender.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-700', 'light:hover:bg-gray-50');

                let actualProfitColorClass = 'text-gray-100 light:text-gray-800';
                if (parseFloat(entry.actualProfitLoss) > 0) {
                    actualProfitColorClass = 'text-green-400';
                } else if (parseFloat(entry.actualProfitLoss) < 0) {
                    actualProfitColorClass = 'text-red-400';
                }

                let statusColorClass = 'text-gray-300 light:text-gray-700';
                if (entry.status === 'Cíl splněn') {
                    statusColorClass = 'text-green-400';
                } else if (entry.status === 'Pod cílem (zisk)') {
                    statusColorClass = 'text-yellow-400';
                } else if (entry.status === 'Ztráta/Pod cílem') {
                    statusColorClass = 'text-red-400';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100 light:text-gray-800">${entry.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200 light:text-gray-700">${formatCurrency(parseFloat(entry.balance))}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-200 light:text-gray-700">${formatCurrency(parseFloat(entry.targetProfit))}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${actualProfitColorClass}">${formatCurrency(parseFloat(entry.actualProfitLoss))}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${statusColorClass}">${entry.status}</td>
                    <td class="px-6 py-4 whitespace-pre-wrap text-sm text-gray-200 light:text-gray-700 max-w-xs">${entry.notes ? entry.notes : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${entry.id}" class="edit-btn text-indigo-400 hover:text-indigo-600 light:text-indigo-600 light:hover:text-indigo-800">Upravit</button>
                    </td>
                `;
                historyTableBody.appendChild(row);
            });

            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const entryId = event.target.dataset.id;
                    const entryToEdit = entries.find(entry => entry.id === entryId);
                    if (entryToEdit) {
                        openDailyEntryPage(entryToEdit); 
                    }
                });
            });
        };

        /**
         * Renders the Chart.js graphs based on current filtered entries.
         * @param {Array} filteredEntries - Entries filtered for the current period.
         * @param {number} initialBalanceForPeriod - The starting balance for the current period.
         */
        const renderCharts = (filteredEntries, initialBalanceForPeriod) => {
            const dates = filteredEntries.map(entry => entry.date);
            const actualProfits = filteredEntries.map(entry => parseFloat(entry.actualProfitLoss));
            const targetProfits = filteredEntries.map(entry => parseFloat(entry.balance) * (globalSettings.targetPercentage / 100));

            let cumulativeBalanceData = [];
            const chartDates = ["Start"].concat(dates); 

            // Start cumulative balance for chart from the initialBalanceForPeriod
            if (filteredEntries.length > 0) {
                let currentCumulative = initialBalanceForPeriod;
                cumulativeBalanceData.push(currentCumulative);
                filteredEntries.forEach(entry => {
                    currentCumulative += parseFloat(entry.actualProfitLoss);
                    cumulativeBalanceData.push(currentCumulative);
                });
            } else {
                cumulativeBalanceData.push(initialBalanceForPeriod);
            }

            const chartColors = {
                blue: { background: 'rgba(99, 179, 237, 0.2)', border: '#63b3ed' },
                green: { background: 'rgba(52, 211, 153, 0.2)', border: '#34d399' },
                purple: { background: 'rgba(162, 28, 222, 0.2)', border: '#A21CDE' },
                yellow: { background: 'rgba(252, 211, 77, 0.2)', border: '#FCD34D' },
                red: { background: 'rgba(239, 68, 68, 0.2)', border: '#EF4444' },
                grayText: document.body.classList.contains('dark') ? '#cbd5e0' : '#4a5568',
                gridLine: document.body.classList.contains('dark') ? '#4a5568' : '#e2e8f0'
            };

            if (equityChartInstance) {
                equityChartInstance.destroy();
            }
            if (dailyPnLChartInstance) {
                dailyPnLChartInstance.destroy();
            }

            const ctxEquity = document.getElementById('equityChart').getContext('2d');
            equityChartInstance = new Chart(ctxEquity, {
                type: 'line',
                data: {
                    labels: chartDates,
                    datasets: [{
                        label: 'Zůstatek účtu',
                        data: cumulativeBalanceData,
                        borderColor: chartColors.blue.border,
                        backgroundColor: chartColors.blue.background,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: { ticks: { color: chartColors.grayText }, grid: { color: chartColors.gridLine } },
                        y: { ticks: { color: chartColors.grayText }, grid: { color: chartColors.gridLine } }
                    },
                    plugins: { legend: { labels: { color: chartColors.grayText } } }
                }
            });

            const ctxDailyPnL = document.getElementById('dailyPnLChart').getContext('2d');
            dailyPnLChartInstance = new Chart(ctxDailyPnL, {
                type: 'bar', 
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Skutečný zisk/ztráta',
                            data: actualProfits,
                            backgroundColor: (context) => {
                                const value = context.dataset.data[context.dataIndex];
                                return value >= 0 ? chartColors.green.border : chartColors.red.border;
                            },
                            borderColor: (context) => {
                                const value = context.dataset.data[context.dataIndex];
                                return value >= 0 ? chartColors.green.border : chartColors.red.border;
                            },
                            borderWidth: 1
                        },
                        {
                            label: 'Cílový zisk',
                            data: targetProfits,
                            backgroundColor: chartColors.purple.background,
                            borderColor: chartColors.purple.border,
                            type: 'line', 
                            fill: false,
                            tension: 0.3,
                            pointRadius: 5,
                            pointBackgroundColor: chartColors.purple.border
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: { ticks: { color: chartColors.grayText }, grid: { color: chartColors.gridLine } },
                        y: { ticks: { color: chartColors.grayText }, grid: { color: chartColors.gridLine } }
                    },
                    plugins: { legend: { labels: { color: chartColors.grayText } } }
                }
            });
        };

        // --- Page Navigation Functions ---

        /**
         * Displays a specific page and hides others.
         * @param {HTMLElement} pageToShow - The page element to display.
         */
        const showPage = (pageToShow) => {
            // Hide all main page content sections
            dashboardPage.classList.add('hidden');
            dailyEntryPage.classList.add('hidden');
            settingsModal.classList.add('hidden'); 

            // Show the requested page
            pageToShow.classList.remove('hidden');
            closeSidebar(); // Close sidebar when navigating to a new page
        };

        /**
         * Opens the daily entry page. Can receive an optional entry object for edit mode.
         * @param {object} [entryToEdit=null] - The entry object to edit. If null, it's add mode.
         */
        const openDailyEntryPage = (entryToEdit = null) => {
            showPage(dailyEntryPage);

            if (entryToEdit) {
                editingEntryId = entryToEdit.id;
                dailyEntryPageTitle.textContent = 'Upravit denní záznam';
                addOrUpdateEntryBtn.textContent = 'Uložit změny';

                dailyBalanceInput.value = parseFloat(entryToEdit.balance).toFixed(2); // Opening balance for this day
                profitLossInput.value = parseFloat(entryToEdit.actualProfitLoss).toFixed(2);
                winningTradesInput.value = entryToEdit.winningTrades || 0;
                losingTradesInput.value = entryToEdit.losingTrades || 0;
                dateInput.value = entryToEdit.date;
                notesInput.value = entryToEdit.notes || '';
            } else {
                editingEntryId = null;
                dailyEntryPageTitle.textContent = 'Zadat denní výsledek';
                addOrUpdateEntryBtn.textContent = 'Přidat záznam';

                // Calculate the opening balance for the new day
                if (entries.length > 0) {
                    const lastEntry = entries[entries.length - 1];
                    const lastClosingBalance = parseFloat(lastEntry.cumulativeBalanceAfterEntry); 
                    dailyBalanceInput.value = lastClosingBalance.toFixed(2);
                } else {
                    dailyBalanceInput.value = globalSettings.initialOverallBalance.toFixed(2);
                }
                setTodayDate();
                profitLossInput.value = '';
                winningTradesInput.value = '';
                losingTradesInput.value = '';
                notesInput.value = '';
            }

            aiAnalysisSection.classList.add('hidden');
            aiAnalysisResult.textContent = '';
            aiLoadingSpinner.classList.add('hidden');
        };

        const closeDailyEntryPage = () => {
            showPage(dashboardPage);
            // Re-apply the current period filter to ensure dashboard is updated correctly
            applyPeriodFilter(currentSelectedPeriod); 
            editingEntryId = null; 
            addOrUpdateEntryBtn.textContent = 'Přidat záznam'; 
            dailyEntryPageTitle.textContent = 'Zadat denní výsledek'; 
        };

        const openSettingsModal = () => {
            showPage(settingsModal); // Show settings modal as a full page overlay
            initialOverallBalanceInput.value = globalSettings.initialOverallBalance;
            globalTargetPercentageInput.value = globalSettings.targetPercentage;
            globalPercentageValueSpan.textContent = globalSettings.targetPercentage;
            settingsStatusMessage.classList.add('hidden');
            closeSidebar(); // Close sidebar when opening settings modal
        };

        const closeSettingsModal = () => {
            showPage(dashboardPage); // Return to dashboard
            // Re-apply the current period filter to ensure dashboard is updated correctly after settings change
            applyPeriodFilter(currentSelectedPeriod); 
        };


        // --- Custom Confirm Dialog Logic ---
        const showCustomConfirm = (message, onConfirm) => {
            confirmMessageElement.textContent = message;
            customConfirmModal.classList.remove('hidden');
            confirmCallbackFn = onConfirm;
        };


        // --- window.onload (Main entry point for JavaScript) ---
        window.onload = async () => {
            // Display initial loading message
            initialStatusMessageElement = document.getElementById('initialStatusMessage'); 
            initialStatusMessageElement.classList.remove('hidden');

            // --- 1. Get all DOM element references ---
            try {
                mainContent = document.getElementById('mainContent'); 
                dashboardPage = document.getElementById('dashboardPage'); 
                dailyEntryPage = document.getElementById('dailyEntryPage'); 
                settingsModal = document.getElementById('settingsModal'); 

                sidebar = document.getElementById('sidebar'); 
                sidebarOverlay = document.getElementById('sidebarOverlay'); 
                menuToggleBtn = document.getElementById('menuToggleBtn'); 
                sidebarCloseBtn = document.getElementById('sidebarCloseBtn'); 
                sidebarSettingsBtn = document.getElementById('sidebarSettingsBtn'); 
                sidebarThemeToggle = document.getElementById('sidebarThemeToggle'); 
                sidebarSunIcon = document.getElementById('sidebarSunIcon'); 
                sidebarMoonIcon = document.getElementById('sidebarMoonIcon'); 

                dailyEntryPageTitle = document.getElementById('dailyEntryPageTitle'); 
                dailyBalanceInput = document.getElementById('dailyBalanceInput'); 
                profitLossInput = document.getElementById('profitLossInput'); 
                winningTradesInput = document.getElementById('winningTradesInput'); 
                losingTradesInput = document.getElementById('losingTradesInput'); 
                dateInput = document.getElementById('dateInput'); 
                notesInput = document.getElementById('notesInput'); 
                addOrUpdateEntryBtn = document.getElementById('addOrUpdateEntryBtn'); 
                analyzeNotesBtn = document.getElementById('analyzeNotesBtn'); 
                aiAnalysisSection = document.getElementById('aiAnalysisSection'); 
                aiAnalysisResult = document.getElementById('aiAnalysisResult'); 
                aiLoadingSpinner = document.getElementById('aiLoadingSpinner'); 

                historyTableBody = document.getElementById('historyTableBody'); 
                clearHistoryBtn = document.getElementById('clearHistoryBtn'); 

                dashboardInitialBalance = document.getElementById('dashboardInitialBalance'); 
                dashboardLastBalance = document.getElementById('dashboardLastBalance'); 
                dashboardTarget = document.getElementById('dashboardTarget'); 
                dashboardTargetPct = document.getElementById('dashboardTargetPct'); 
                dashboardActual = document.getElementById('dashboardActual'); 
                progressBar = document.getElementById('progressBar'); 
                progressPercentage = document.getElementById('progressPercentage'); 
                statusMessage = document.getElementById('statusMessage'); 

                winRateDisplay = document.getElementById('winRateDisplay'); 
                totalTradesDisplay = document.getElementById('totalTradesDisplay'); 
                winsLossesSubtext = document.getElementById('winsLossesSubtext'); 
                streaksDisplay = document.getElementById('streaksDisplay'); 
                streaksSubtext = document.getElementById('streaksSubtext'); 
                maxDailyProfitDisplay = document.getElementById('maxDailyProfitDisplay'); 

                avgDailyProfitDisplay = document.getElementById('avgDailyProfitDisplay'); 
                latestProfitLossPctDisplay = document.getElementById('latestProfitLossPctDisplay'); 
                maxDrawdownDisplay = document.getElementById('maxDrawdownDisplay'); 
                profitLossDaysDisplay = document.getElementById('profitLossDaysDisplay'); 
                weeklyProfitDisplay = document.getElementById('weeklyProfitDisplay'); 
                avgRRDisplay = document.getElementById('avgRRDisplay'); 

                monthlyTargetBalanceDisplay = document.getElementById('monthlyTargetBalanceDisplay'); 
                monthlyProgressPercentage = document.getElementById('monthlyProgressPercentage'); 
                monthlyProgressBar = document.getElementById('monthlyProgressBar'); 
                monthlyRemainingAmount = document.getElementById('monthlyRemainingAmount'); 
                monthlyTradingDaysCount = document.getElementById('monthlyTradingDaysCount'); 
                yearlyTargetBalanceDisplay = document.getElementById('yearlyTargetBalanceDisplay'); 
                yearlyProgressPercentage = document.getElementById('yearlyProgressPercentage'); 
                yearlyProgressBar = document.getElementById('yearlyProgressBar'); 
                yearlyRemainingAmount = document.getElementById('yearlyRemainingAmount'); 
                yearlyTradingDaysCount = document.getElementById('yearlyTradingDaysCount'); 

                periodSelect = document.getElementById('periodSelect'); 
                currentPeriodLabel = document.getElementById('currentPeriodLabel'); 

                addEntryFab = document.getElementById('addEntryFab'); 
                closeDailyEntryPageBtn = document.getElementById('closeDailyEntryPageBtn'); 
                closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn'); 

                initialOverallBalanceInput = document.getElementById('initialOverallBalanceInput'); 
                globalTargetPercentageInput = document.getElementById('globalTargetPercentage'); 
                globalPercentageValueSpan = document.getElementById('globalPercentageValue'); 
                saveSettingsBtn = document.getElementById('saveSettingsBtn'); 
                settingsStatusMessage = document.getElementById('settingsStatusMessage'); 
                historyTargetPct = document.getElementById('historyTargetPct'); 

                customConfirmModal = document.getElementById('customConfirmModal'); 
                confirmBtn = document.getElementById('okConfirmBtn'); 
                cancelBtn = document.getElementById('cancelConfirmBtn'); 
                confirmMessageElement = document.getElementById('confirmMessage'); 

                applySavedTheme();
                setTodayDate();
                showPage(dashboardPage); 
            } catch (domError) {
                console.error("Critical DOM element retrieval error:", domError);
                initialStatusMessageElement.textContent = `Chyba při načítání prvků stránky: ${domError.message}. Ujistěte se, že HTML struktura je správná.`;
                initialStatusMessageElement.classList.remove('hidden');
                return; 
            }

            // --- 2. Setup Event Listeners (AFTER all DOM elements are referenced) ---
            try {
                addEntryFab.addEventListener('click', () => openDailyEntryPage());
                closeDailyEntryPageBtn.addEventListener('click', closeDailyEntryPage);
                dailyEntryPage.addEventListener('click', (e) => {
                    if (e.target === dailyEntryPage) {
                        closeDailyEntryPage();
                    }
                });

                menuToggleBtn.addEventListener('click', openSidebar);
                sidebarCloseBtn.addEventListener('click', closeSidebar);
                sidebarOverlay.addEventListener('click', closeSidebar);
                sidebarSettingsBtn.addEventListener('click', openSettingsModal);
                sidebarThemeToggle.addEventListener('click', toggleTheme);

                closeSettingsModalBtn.addEventListener('click', closeSettingsModal);
                settingsModal.addEventListener('click', (e) => {
                    if (e.target === settingsModal) {
                        closeSettingsModal();
                    }
                });

                periodSelect.addEventListener('change', (event) => {
                    applyPeriodFilter(event.target.value);
                });

                addOrUpdateEntryBtn.addEventListener('click', async () => {
                    const balance = parseFloat(dailyBalanceInput.value); 
                    const profitLoss = parseFloat(profitLossInput.value);
                    const winningTrades = parseInt(winningTradesInput.value) || 0; 
                    const losingTrades = parseInt(losingTradesInput.value) || 0;   
                    const date = dateInput.value;
                    const notes = notesInput.value.trim();

                    if (isNaN(balance) || isNaN(profitLoss) || !date) {
                        aiAnalysisResult.textContent = 'Vyplňte prosím všechna povinná pole (Zisk/Ztráta, Datum). Počáteční zůstatek se vyplní automaticky.';
                        aiAnalysisResult.style.color = '#ef4444';
                        aiAnalysisSection.classList.remove('hidden');
                        setTimeout(() => {
                            aiAnalysisResult.textContent = '';
                            aiAnalysisSection.classList.add('hidden');
                        }, 3000);
                        return;
                    }

                    const calculatedTarget = balance * (globalSettings.targetPercentage / 100);
                    let status;
                    if (profitLoss >= calculatedTarget) {
                        status = 'Cíl splněn';
                    } else if (profitLoss > 0) {
                        status = 'Pod cílem (zisk)';
                    } else {
                        status = 'Ztráta/Pod cílem';
                    }

                    const entryData = {
                        balance: balance, 
                        targetPercentage: globalSettings.targetPercentage,
                        targetProfit: calculatedTarget,
                        actualProfitLoss: profitLoss,
                        winningTrades: winningTrades, 
                        losingTrades: losingTrades,   
                        date: date, 
                        status: status,
                        notes: notes,
                    };

                    if (editingEntryId) {
                        await updateEntryInFirestore(editingEntryId, entryData);
                    } else {
                        await saveEntryToFirestore(entryData);
                    }

                    profitLossInput.value = '';
                    winningTradesInput.value = ''; 
                    losingTradesInput.value = '';   
                    notesInput.value = '';
                    aiAnalysisSection.classList.add('hidden');
                    aiAnalysisResult.textContent = '';
                    aiLoadingSpinner.classList.add('hidden');
                    setTodayDate();
                    closeDailyEntryPage(); 
                    editingEntryId = null; 
                    addOrUpdateEntryBtn.textContent = 'Přidat záznam'; 
                    dailyEntryPageTitle.textContent = 'Zadat denní výsledek'; 
                });

                analyzeNotesBtn.addEventListener('click', async () => {
                    const notes = notesInput.value.trim();
                    if (!notes) {
                        aiAnalysisSection.classList.remove('hidden');
                        aiAnalysisResult.textContent = 'Prosím, zadejte nějaké poznámky k analýze.';
                        aiAnalysisResult.style.color = '#ef4444';
                        aiLoadingSpinner.classList.add('hidden');
                        return;
                    }

                    aiAnalysisSection.classList.remove('hidden');
                    aiAnalysisResult.textContent = '';
                    aiAnalysisResult.style.color = '';
                    aiLoadingSpinner.classList.remove('hidden');

                    try {
                        let chatHistory = [];
                        const prompt = `Analyzujte následující obchodní deníkové poznámky pro sentiment, opakující se vzorce a poskytněte obecné poznatky nebo tipy na základě obsahu. Zaměřte se na praktickou zpětnou vazbu. Poznámky: ${notes}`;
                        
                        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                        const payload = { contents: chatHistory };
                        const apiKey = firebaseConfig.apiKey; // Použijte API klíč z vaší konfigurace
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();

                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            aiAnalysisResult.textContent = result.candidates[0].content.parts[0].text;
                        } else {
                            aiAnalysisResult.textContent = 'Nepodařilo se získat analýzu. Zkuste to prosím znovu.';
                            aiAnalysisResult.style.color = '#ef4444';
                        }
                    } catch (error) {
                        console.error('Chyba při volání Gemini API:', error);
                        aiAnalysisResult.textContent = 'Došlo k chybě při analýze poznámek. Zkuste to prosím znovu později.';
                        aiAnalysisResult.style.color = '#ef4444';
                    } finally {
                        aiLoadingSpinner.classList.add('hidden');
                    }
                });

                clearHistoryBtn.addEventListener('click', () => {
                    showCustomConfirm('Opravdu chcete vymazat celou historii? Tato akce je nevratná.', async () => {
                        await clearAllEntriesFromFirestore(); 
                        dailyBalanceInput.value = globalSettings.initialOverallBalance.toFixed(2);
                    });
                });

                globalTargetPercentageInput.addEventListener('input', () => {
                    globalPercentageValueSpan.textContent = globalTargetPercentageInput.value;
                });

                saveSettingsBtn.addEventListener('click', async () => {
                    const newInitialBalance = parseFloat(initialOverallBalanceInput.value);
                    const newTargetPercentage = parseFloat(globalTargetPercentageInput.value);

                    if (isNaN(newInitialBalance) || newInitialBalance < 0 || isNaN(newTargetPercentage) || newTargetPercentage < 1 || newTargetPercentage > 10) {
                        settingsStatusMessage.textContent = 'Neplatné hodnoty. Zůstatek musí být nezáporný a procento mezi 1 a 10.';
                        settingsStatusMessage.style.color = '#ef4444';
                        settingsStatusMessage.classList.remove('hidden');
                        return;
                    }

                    const newSettings = {
                        initialOverallBalance: newInitialBalance,
                        targetPercentage: newTargetPercentage
                    };
                    await saveSettingsToFirestore(newSettings); 

                    if (entries.length === 0 && dailyEntryPage.classList.contains('hidden') === false) { 
                        dailyBalanceInput.value = newInitialBalance.toFixed(2);
                    }
                });

                // Custom Confirm Dialog Listeners
                confirmBtn.addEventListener('click', () => {
                    if (confirmCallbackFn) {
                        confirmCallbackFn();
                    }
                    customConfirmModal.classList.add('hidden');
                });

                cancelBtn.addEventListener('click', () => {
                    customConfirmModal.classList.add('hidden');
                });
            } catch (listenerError) {
                console.error("Critical event listener setup error:", listenerError);
                initialStatusMessageElement.textContent = `Chyba při nastavení interakcí: ${listenerError.message}. Zkuste znovu načíst stránku.`;
                initialStatusMessageElement.classList.remove('hidden');
                return; 
            }

            // --- 3. Firebase Initialization and Authentication ---
            try {
                // Initialize Firebase with the directly provided config
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // For local execution, we will sign in anonymously.
                // The __initial_auth_token is not available here.
                await signInAnonymously(auth);
                console.log("Firebase: Signed in anonymously for local execution.");
                
                // Listen for auth state changes to get the user ID and then setup Firestore data listeners
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; // Use the anonymous user's UID
                        console.log("Firebase: Auth state changed. User ID:", userId);
                        setupFirestoreListeners(); 
                    } else {
                        // This case might happen if the anonymous session expires or is manually signed out.
                        // For this app, we simply assign a new random ID, but this won't persist across browser closures.
                        userId = crypto.randomUUID(); 
                        console.warn("Firebase: User is not signed in. Using a random temporary ID for data operations. Data persistence for this ID will be limited.");
                        setupFirestoreListeners(); 
                    }
                }, (error) => {
                    console.error("Firebase Auth state change error:", error);
                    initialStatusMessageElement.textContent = `Chyba při přihlašování do Firebase: ${error.message}. Zkontrolujte nastavení autentizace.`;
                    initialStatusMessageElement.classList.remove('hidden');
                });

            } catch (firebaseInitError) {
                console.error("Critical error during Firebase initialization or authentication:", firebaseInitError);
                initialStatusMessageElement.textContent = `Kritická chyba při spuštění Firebase: ${firebaseInitError.message}. Zkontrolujte konzoli a nastavení projektu Firebase.`;
                initialStatusMessageElement.classList.remove('hidden');
            }
        }; 
    </script>

    <!-- Main Application Content -->
    <div id="mainContent" class="dark min-h-screen p-4 flex flex-col items-center">
        <h1 class="text-4xl font-bold text-center mb-8 text-blue-400">Daily Trade Goal Tracker</h1>

        <!-- Dashboard Page Content -->
        <div id="dashboardPage" class="hidden">
            <div class="card p-6 mb-8">
                <h2 class="text-2xl font-bold mb-6 text-blue-400">Přehled výkonu</h2>
                
                <!-- Period Filter -->
                <div class="flex flex-col md:flex-row items-center justify-between mb-6 space-y-3 md:space-y-0 md:space-x-4">
                    <label for="periodSelect" class="text-gray-300 light:text-gray-700 whitespace-nowrap">Zobrazeno období: <span id="currentPeriodLabel" class="font-semibold text-blue-400">Celková historie</span></label>
                    <select id="periodSelect" class="w-full md:w-auto p-2 rounded-md bg-gray-700 border border-gray-600 text-white light:bg-gray-100 light:border-gray-300 light:text-gray-800 focus:ring-blue-500 focus:border-blue-500">
                        <!-- Options will be dynamically populated by JavaScript -->
                    </select>
                </div>

                <!-- Main metric grid based on user's image -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <!-- Okamžitý finanční stav -->
                    <!-- Aktuální zůstatek (Dynamický) -->
                    <div class="dashboard-card-metric">
                        <div class="dashboard-card-title">Aktuální zůstatek</div>
                        <div id="dashboardLastBalance" class="dashboard-card-value text-blue-main">$0.00</div>
                        <div class="dashboard-card-subtext">Váš celkový zůstatek</div>
                    </div>

                    <!-- Denní zisk (Poslední den) (Dynamický) -->
                    <div class="dashboard-card-metric highlight-card bg-blue-900 light:bg-blue-100">
                        <div class="dashboard-card-title text-blue-200 light:text-blue-800">Denní zisk</div>
                        <div id="dashboardActual" class="dashboard-card-value text-green-success">$0.00</div>
                        <div class="dashboard-card-subtext">Výsledek z posledního záznamu</div>
                    </div>

                    <!-- Poslední % Zisk/Ztráta -->
                    <div class="dashboard-card-metric">
                        <div class="dashboard-card-title">Poslední % Zisk/Ztráta</div>
                        <div id="latestProfitLossPctDisplay" class="dashboard-card-value text-purple-accent">0.0%</div>
                        <div class="dashboard-card-subtext">Vůči počátečnímu zůstatku</div>
                    </div>

                    <!-- Celková výkonnost a konzistence -->
                    <!-- Průměrný denní zisk ($/%) -->
                    <div class="dashboard-card-metric">
                        <div class="dashboard-card-title">Prům. denní zisk</div>
                        <div id="avgDailyProfitDisplay" class="dashboard-card-value text-blue-main">$0.00 / 0.0%</div>
                        <div class="dashboard-card-subtext">Průměr za všechny dny</div>
                    </div>

                    <!-- Největší denní zisk -->
                    <div class="dashboard-card-metric">
                        <div class="dashboard-card-title">Největší denní zisk</div>
                        <div id="maxDailyProfitDisplay" class="dashboard-card-value text-purple-accent">$0.00</div>
                        <div class="dashboard-card-subtext">Váš nejvyšší zisk za den</div>
                    </div>

                    <!-- Týdenní zisk (součet posledních 7 dnů) -->
                    <div class="dashboard-card-metric">
                        <div class="dashboard-card-title">Týdenní zisk</div>
                        <div id="weeklyProfitDisplay" class="dashboard-card-value text-blue-main">$0.00</div>
                        <div class="dashboard-card-subtext">Součet za posledních 7 dní</div>
                    </div>
                    
                    <!-- Řízení rizika a efektivita strategie -->
                    <!-- Max. propad (Drawdown) -->
                    <div class="dashboard-card-metric">
                        <div class="dashboard-card-title">Max. propad</div>
                        <div id="maxDrawdownDisplay" class="dashboard-card-value text-red-danger">0.0%</div>
                        <div class="dashboard-card-subtext">Největší pokles kapitálu</div>
                    </div>

                    <!-- Prům. RR -->
                    <div class="dashboard-card-metric">
                        <div class="dashboard-card-title">Prům. RR</div>
                        <div id="avgRRDisplay" class="dashboard-card-value text-purple-accent">N/A</div>
                        <div class="dashboard-card-subtext">Odměna/Riziko</div>
                    </div>

                    <!-- Obchodní aktivita a chování -->
                    <!-- Procento výher (Dynamický) -->
                    <div class="dashboard-card-metric">
                        <div class="dashboard-card-title">Procento výher</div>
                        <div id="winRateDisplay" class="dashboard-card-value text-green-success">0%</div>
                        <div id="winsLossesSubtext" class="dashboard-card-subtext">0 Wins - 0 Losses</div>
                    </div>

                    <!-- Obchody celkem (Dynamický) -->
                    <div class="dashboard-card-metric">
                        <div class="dashboard-card-title">Obchody celkem</div>
                        <div id="totalTradesDisplay" class="dashboard-card-value">0</div>
                        <div class="dashboard-card-subtext">Celkový počet obchodů</div>
                    </div>

                    <!-- Série (Dynamický) -->
                    <div class="dashboard-card-metric">
                        <div class="dashboard-card-title">Série</div>
                        <div id="streaksDisplay" class="dashboard-card-value text-green-success">---</div>
                        <div id="streaksSubtext" class="dashboard-card-subtext">Nejdelší souvislá</div>
                    </div>

                    <!-- Počet dnů v zisku vs. ve ztrátě -->
                    <div class="dashboard-card-metric">
                        <div class="dashboard-card-title">Zisk/Ztráta dnů</div>
                        <div id="profitLossDaysDisplay" class="dashboard-card-value">
                            <span class="text-green-success">0</span> / <span class="text-red-danger">0</span>
                        </div>
                        <div class="dashboard-card-subtext">Celkový počet dnů</div>
                    </div>

                </div>

                <!-- Original app's core metrics - placed separately -->
                <!-- This section now focuses on overall balance and daily goal progress -->
                <div class="mt-8 p-6 bg-gray-800 rounded-xl light:bg-gray-200 shadow-md">
                    <h3 class="text-xl font-bold mb-3 text-gray-300 light:text-gray-700">Přehled denních cílů</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                        <div class="p-3 bg-gray-700 rounded-lg light:bg-white shadow-sm">
                            <div class="text-sm font-medium text-gray-400 light:text-gray-600">Počáteční zůstatek období</div>
                            <div id="dashboardInitialBalance" class="text-xl font-bold text-gray-300 light:text-gray-800">$0.00</div>
                        </div>
                        <div class="p-3 bg-gray-700 rounded-lg light:bg-white shadow-sm">
                            <div class="text-sm font-medium text-gray-400 light:text-gray-600">Cíl denního zisku (<span id="dashboardTargetPct">3</span>%)</div>
                            <div id="dashboardTarget" class="text-xl font-bold text-purple-accent">$0.00</div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar Section (integrated below balances) -->
                    <div class="mt-6">
                        <div class="text-sm font-medium text-gray-400 light:text-gray-600 mb-2">Pokrok k dennímu cíli: <span id="progressPercentage">0%</span></div>
                        <div class="w-full bg-gray-600 rounded-full h-4 dark:bg-gray-500">
                            <div id="progressBar" class="bg-blue-500 h-4 rounded-full progress-bar-fill" style="width: 0%;"></div>
                        </div>
                        <div id="statusMessage" class="text-center mt-3 text-lg font-semibold text-gray-300 light:text-gray-700">Zadejte první záznam!</div>
                    </div>
                </div>

                <!-- Monthly and Yearly Goals Section (NOW DYNAMICALLY CALCULATED) -->
                <div class="mt-8 p-6 bg-gray-800 rounded-xl light:bg-gray-200 shadow-md">
                    <h3 class="text-xl font-bold mb-3 text-gray-300 light:text-gray-700">Měsíční a Roční cíle (Projekce pro vybrané období)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                        <!-- Monthly Goal -->
                        <div class="p-3 bg-gray-700 rounded-lg light:bg-white shadow-sm">
                            <div class="text-sm font-medium text-gray-400 light:text-gray-600">Měsíční cílový zůstatek</div>
                            <div id="monthlyTargetBalanceDisplay" class="text-xl font-bold text-blue-main">$0.00</div>
                            <div class="text-sm font-medium text-gray-400 light:text-gray-600 mt-2">Pokrok: <span id="monthlyProgressPercentage">0%</span></div>
                            <div id="monthlyRemainingAmount" class="text-sm font-bold text-green-success mt-1">$0.00</div>
                            <div class="w-full bg-gray-600 rounded-full h-3 dark:bg-gray-500 mt-1">
                                <div id="monthlyProgressBar" class="bg-blue-500 h-3 rounded-full progress-bar-fill" style="width: 0%;"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1"> (na základě <span id="monthlyTradingDaysCount">0</span> obchodních dnů) </div>
                        </div>
                        <!-- Yearly Goal -->
                        <div class="p-3 bg-gray-700 rounded-lg light:bg-white shadow-sm">
                            <div class="text-sm font-medium text-gray-400 light:text-gray-600">Roční cílový zůstatek</div>
                            <div id="yearlyTargetBalanceDisplay" class="text-xl font-bold text-blue-main">$0.00</div>
                            <div class="text-sm font-medium text-gray-400 light:text-gray-600 mt-2">Pokrok: <span id="yearlyProgressPercentage">0%</span></div>
                            <div id="yearlyRemainingAmount" class="text-sm font-bold text-green-success mt-1">$0.00</div>
                            <div class="w-full bg-gray-600 rounded-full h-3 dark:bg-gray-500 mt-1">
                                <div id="yearlyProgressBar" class="bg-blue-500 h-3 rounded-full progress-bar-fill" style="width: 0%;"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1"> (na základě <span id="yearlyTradingDaysCount">250</span> obchodních dnů) </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-200 light:text-gray-700">Vývoj zůstatku účtu</h3>
                    <canvas id="equityChart"></canvas>
                </div>
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-200 light:text-gray-700">Denní zisk vs. Cíl</h3>
                    <canvas id="dailyPnLChart"></canvas>
                </div>
            </div>

            <!-- History Section -->
            <div class="card p-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-200 light:text-gray-700">Historie záznamů</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700 light:divide-gray-300">
                        <thead class="bg-gray-700 light:bg-gray-100">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 light:text-gray-600 uppercase tracking-wider rounded-tl-lg">Datum</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 light:text-gray-600 uppercase tracking-wider">Poč. zůstatek</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 light:text-gray-600 uppercase tracking-wider">Cílový zisk (<span id="historyTargetPct">3</span>%)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 light:text-gray-600 uppercase tracking-wider">Skutečný zisk</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 light:text-gray-600 uppercase tracking-wider">Stav</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 light:text-gray-600 uppercase tracking-wider">Poznámky</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-400 light:text-gray-600 uppercase tracking-wider rounded-tr-lg">Akce</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="bg-gray-800 divide-y divide-gray-700 light:bg-white light:divide-gray-200">
                            <!-- History entries will be rendered here -->
                        </tbody>
                    </table>
                </div>
                <button id="clearHistoryBtn" class="mt-6 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transform transition duration-200 hover:scale-105">
                    Vymazat historii
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Action Button (FAB) -->
    <button id="addEntryFab" class="fab">
        <svg fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path>
        </svg>
    </button>

    <!-- Daily Entry Page Content -->
    <div id="dailyEntryPage" class="full-page-overlay hidden">
        <div class="full-page-content card">
            <button class="close-button" id="closeDailyEntryPageBtn">&times;</button>
            <h2 id="dailyEntryPageTitle" class="text-2xl font-semibold mb-4 text-gray-200 light:text-gray-700">Zadat denní výsledek</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="dailyBalanceInput" class="block text-sm font-medium text-gray-400 light:text-gray-600 mb-1">Počáteční denní zůstatek (USD)</label>
                    <input type="number" id="dailyBalanceInput" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white light:bg-gray-100 light:border-gray-300 light:text-gray-800 focus:ring-blue-500 focus:border-blue-500" placeholder="Automaticky vypočteno" min="0" disabled>
                </div>
                <div>
                    <label for="profitLossInput" class="block text-sm font-medium text-gray-400 light:text-gray-600 mb-1">Skutečný denní zisk/ztráta (USD)</label>
                    <input type="number" id="profitLossInput" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white light:bg-gray-100 light:border-gray-300 light:text-gray-800 focus:ring-blue-500 focus:border-blue-500" placeholder="Např. 1.20">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="winningTradesInput" class="block text-sm font-medium text-gray-400 light:text-gray-600 mb-1">Vítězné obchody</label>
                    <input type="number" id="winningTradesInput" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white light:bg-gray-100 light:border-gray-300 light:text-gray-800 focus:ring-blue-500 focus:border-blue-500" placeholder="Např. 5" min="0">
                </div>
                <div>
                    <label for="losingTradesInput" class="block text-sm font-medium text-gray-400 light:text-gray-600 mb-1">Ztrátové obchody</label>
                    <input type="number" id="losingTradesInput" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white light:bg-gray-100 light:border-gray-300 light:text-gray-800 focus:ring-blue-500 focus:border-blue-500" placeholder="Např. 2" min="0">
                </div>
            </div>

            <div class="mb-4">
                <label for="dateInput" class="block text-sm font-medium text-gray-400 light:text-gray-600 mb-1">Datum</label>
                <input type="date" id="dateInput" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white light:bg-gray-100 light:border-gray-300 light:text-gray-800 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="mb-6">
                <label for="notesInput" class="block text-sm font-medium text-gray-400 light:text-gray-600 mb-1">Poznámky</label>
                <textarea id="notesInput" rows="3" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white light:bg-gray-100 light:border-gray-300 light:text-gray-800 focus:ring-blue-500 focus:border-blue-500" placeholder="Přidejte poznámky k tomuto dni..."></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="addOrUpdateEntryBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform transition duration-200 hover:scale-105">
                    Přidat záznam
                </button>
                <button id="analyzeNotesBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform transition duration-200 hover:scale-105">
                    ✨ Analyzovat poznámky AI ✨
                </button>
            </div>

            <!-- AI Analysis Result Section -->
            <div id="aiAnalysisSection" class="mt-8 p-4 bg-gray-700 rounded-lg light:bg-gray-100 hidden">
                <h3 class="text-xl font-semibold mb-2 text-gray-200 light:text-gray-700">Analýza poznámek AI</h3>
                <div id="aiAnalysisResult" class="text-gray-300 light:text-gray-700 whitespace-pre-wrap">
                    <!-- AI analysis will be displayed here -->
                </div>
                <div id="aiLoadingSpinner" class="flex justify-center items-center mt-4 hidden">
                    <div class="spinner"></div>
                    <span class="ml-2 text-gray-400 light:text-gray-600">Analýza poznámek...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Settings -->
    <div id="settingsModal" class="full-page-overlay hidden">
        <div class="full-page-content card max-w-xl">
            <button class="close-button" id="closeSettingsModalBtn">&times;</button>
            <h2 class="text-2xl font-semibold mb-4 text-gray-200 light:text-gray-700">Nastavení</h2>
            <div class="mb-4">
                <label for="initialOverallBalanceInput" class="block text-sm font-medium text-gray-400 light:text-gray-600 mb-1">Původní zůstatek účtu (USD)</label>
                <input type="number" id="initialOverallBalanceInput" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 text-white light:bg-gray-100 light:border-gray-300 light:text-gray-800 focus:ring-blue-500 focus:border-blue-500" placeholder="Např. 1000" min="0" value="40">
                <p class="text-xs text-gray-500 mt-1 flex items-center"><svg class="info-icon" fill="currentColor" viewBox="0 0 24 24" width="14" height="14"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg> Toto je váš úplný počáteční zůstatek pro sledování.</p>
            </div>
            <div class="mb-6">
                <label for="globalTargetPercentage" class="block text-sm font-medium text-gray-400 light:text-gray-600 mb-1">Globální cílové procento zisku: <span id="globalPercentageValue">3</span>%</label>
                <input type="range" id="globalTargetPercentage" min="1" max="10" value="3" class="w-full h-2 rounded-lg appearance-none cursor-pointer bg-gray-600 light:bg-gray-300 accent-blue-400">
                <p class="text-xs text-gray-500 mt-1 flex items-center"><svg class="info-icon" fill="currentColor" viewBox="0 0 24 24" width="14" height="14"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg> Toto procento se použije pro výpočet denního cíle zisku z počátečního zůstatku daného dne. Měsíční a roční cíle se z něj odvozují.</p>
            </div>

            <button id="saveSettingsBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform transition duration-200 hover:scale-105">
                Uložit nastavení
            </button>
            <p id="settingsStatusMessage" class="text-center text-sm mt-3 hidden"></p>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="customConfirmModal" class="full-page-overlay hidden">
        <div class="bg-gray-800 rounded-lg p-6 shadow-xl max-w-sm w-full light:bg-white">
            <p id="confirmMessage" class="text-white light:text-gray-800 text-lg mb-4"></p>
            <div class="flex justify-end space-x-4">
                <button id="cancelConfirmBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-500 transition-colors">Zrušit</button>
                <button id="okConfirmBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Potvrdit</button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2>Menu</h2>
            <button id="sidebarCloseBtn" class="sidebar-close-btn">&times;</button>
        </div>
        
        <div id="sidebarSettingsBtn" class="sidebar-item">
            <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm0 18c-3.314 0-6-2.686-6-6s2.686-6 6-6 6 2.686 6 6-2.686 6-6 6zm0-10c-2.209 0-4 1.791-4 4s1.791 4 4 4 4-1.791 4-4-1.791-4-4-4zM10.985 3.328l-1.042 1.831c-.551.107-1.077.266-1.58.462l-1.921-.611c-.513-.163-1.085-.015-1.423.323l-1.396 1.396c-.338.338-.486.91-.323 1.423l.611 1.921c-.196.503-.355 1.029-.462 1.58l-1.831 1.042c-.47.268-.696.837-.52 1.353l.974 2.87c.176.516.745.742 1.353.52l1.042-1.831c-.551-.107 1.077-.266 1.58-.462l1.921.611c.513.163 1.085.015 1.423-.323l1.396-1.396c.338-.338.486-.91.323-1.423l-.611-1.921c.196-.503-.355-1.029-.462 1.58l1.831-1.042c-.47-.268-.696-.837-.52-1.353l-.974-2.87c-.176-.516-.745-.742-1.353-.52z"/>
            </svg>
            Nastavení
        </div>
        
        <div id="sidebarThemeToggle" class="sidebar-item">
            <svg id="sidebarSunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h1M3 12H2m15.325-4.675l.707-.707M6.025 18.025l-.707.707M18.025 6.025l.707-.707M6.025 6.025l-.707-.707M12 18a6 6 0 100-12 6 6 0 000 12z"></path>
            </svg>
            <svg id="sidebarMoonIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9 9 0 008.354-5.646z"></path>
            </svg>
            <span class="ml-2">Tmavý/Světlý motiv</span>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <!-- Menu Toggle Button (Hamburger) -->
    <button id="menuToggleBtn" class="menu-toggle-btn">
        <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M3 5h18v2H3V5zm0 6h18v2H3v-2zm0 6h18v2H3v-2z" clip-rule="evenodd"></path>
        </svg>
    </button>
</body>
</html>